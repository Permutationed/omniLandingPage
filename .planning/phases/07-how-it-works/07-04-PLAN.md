---
phase: 07-how-it-works
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [components/how-it-works/payment-flow-animation.tsx]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees 3-5 animated particles following the SVG path"
    - "Particles are visible during 25%-70% scroll progress"
    - "Particles are staggered along the path (not bunched at same position)"
  artifacts:
    - path: "components/how-it-works/payment-flow-animation.tsx"
      provides: "Particle divs with scroll-linked offset animation"
      contains: "motion.div.*particle|offsetDistance|useTransform.*particle"
  key_links:
    - from: "particle divs"
      to: "progress MotionValue"
      via: "useTransform with staggered input ranges"
      pattern: "useTransform.*progress.*0\\.2.*0\\.7"
---

<objective>
Add scroll-linked particle animation along the SVG payment flow path

Purpose: Close gap in HIW-02 requirement - particles were specified but not implemented
Output: 3-5 animated particles visible during path-drawing scroll phase (25%-70%)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-how-it-works/07-VERIFICATION.md

# Existing implementation to modify
@components/how-it-works/payment-flow-animation.tsx

# Research showing CSS offset-path approach (Pattern 6)
@.planning/phases/07-how-it-works/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add path particles to PaymentFlowAnimation</name>
  <files>components/how-it-works/payment-flow-animation.tsx</files>
  <action>
Add 5 particle divs that animate along the SVG path during scroll progress 25%-70%.

Implementation approach:
1. Extract the path string to a constant (reuse existing path: "M 50 100 C 120 100, 180 100, 200 100")
2. Create 5 motion.div particles with inline styles:
   - `offsetPath: path('${PATH_D}')`
   - `offsetDistance` driven by useTransform
   - `offsetRotate: '0deg'` (no rotation needed)
3. Each particle gets staggered progress ranges:
   - Particle 0: useTransform(progress, [0.20, 0.65], ['0%', '100%'])
   - Particle 1: useTransform(progress, [0.23, 0.68], ['0%', '100%'])
   - Particle 2: useTransform(progress, [0.26, 0.71], ['0%', '100%'])
   - Particle 3: useTransform(progress, [0.29, 0.74], ['0%', '100%'])
   - Particle 4: useTransform(progress, [0.32, 0.77], ['0%', '100%'])
4. Particle styling:
   - Size: w-2 h-2 (8px circle)
   - Color: bg-primary for first 3, bg-amber-500 for last 2 (showing split)
   - Shape: rounded-full
   - Shadow: shadow-sm shadow-primary/50
5. Control visibility with opacity:
   - Each particle fades in at start of its range
   - Particles fade out when path drawing completes

Position particles relative to the SVG container (same parent as the SVG element).

IMPORTANT: Use only the FIRST segment of the path for particles (M 50 100 C 120 100, 180 100, 200 100) - the straight flow before the split. This keeps particles on the main path during their visible range.

Do NOT change existing card, path drawing, or split animations.
  </action>
  <verify>
1. Run `npm run build` - no TypeScript errors
2. Run `npm run dev`
3. Visit localhost:3000 and scroll to How It Works section
4. Observe:
   - 5 small circles appear as path draws
   - Circles move along the path from left toward center
   - Circles are staggered (not all at same position)
   - Circles visible only during path drawing phase
5. Verify existing animations still work: card swipe, path drawing, ACH/rewards split
  </verify>
  <done>
5 particles animate along the SVG path during 25%-70% scroll progress with staggered positions
  </done>
</task>

<task type="auto">
  <name>Task 2: Fine-tune particle visibility and polish</name>
  <files>components/how-it-works/payment-flow-animation.tsx</files>
  <action>
Add opacity transforms for smoother particle appearance:

1. Each particle gets its own opacity transform:
   - Fade in: opacity 0->1 over first 5% of its range
   - Stay visible: opacity 1 during middle of range
   - Fade out: opacity 1->0 over last 5% of its range

Example for particle 0 (range 0.20-0.65):
```typescript
const p0Opacity = useTransform(
  progress,
  [0.20, 0.25, 0.60, 0.65],
  [0, 1, 1, 0]
)
```

2. Add subtle scale animation for each particle:
   - Scale 0.5 -> 1 -> 0.5 over range
   - Creates pulsing effect as particles flow

3. Ensure particles layer correctly:
   - Particles should render ABOVE the SVG path
   - Add z-10 or similar to particle container

4. Add pointer-events-none to particle container so they don't interfere with any clicks.
  </action>
  <verify>
1. Run `npm run dev`
2. Scroll through How It Works section slowly
3. Observe:
   - Particles fade in smoothly (no pop-in)
   - Particles fade out smoothly before split
   - Particles have subtle scale/pulse effect
   - Scroll remains smooth (60fps)
4. Test on mobile viewport - particles should be visible but not distracting
  </verify>
  <done>
Particles have smooth opacity transitions and subtle scale animation, maintaining 60fps performance
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Build verification:**
   - `npm run build` completes without errors
   - No TypeScript errors in payment-flow-animation.tsx

2. **Visual verification:**
   - Particles visible during 25%-70% scroll
   - Particles staggered (5 distinct positions)
   - Smooth fade in/out transitions
   - Existing animations unchanged

3. **Performance verification:**
   - DevTools Performance tab shows no jank during scroll
   - GPU-only properties animated (transform, opacity)

4. **Gap closure:**
   - Re-run verification: "User sees particles along SVG path during middle scroll" should now PASS
</verification>

<success_criteria>
- 5 particle divs animate along the payment flow path
- Particles use CSS offset-path with scroll-linked offset-distance
- Particles visible only during 25%-70% scroll progress range
- Particles are staggered (0.03 progress offset between each)
- Smooth opacity transitions (fade in/out)
- Existing card, path, and split animations unchanged
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-how-it-works/07-04-SUMMARY.md`
</output>
