---
phase: 07-how-it-works
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [components/how-it-works/*, components/how-you-earn/*, app/page.tsx, lib/animation-variants.ts]
autonomous: true

must_haves:
  truths:
    - "Old how-it-works directory is deleted"
    - "New how-you-earn directory exists with section wrapper"
    - "Shared utilities for isometric transforms exist"
    - "Odometer component for animated numbers exists"
    - "Page imports new HowYouEarnSection instead of old component"
  artifacts:
    - path: "components/how-you-earn/how-you-earn-section.tsx"
      provides: "Main section wrapper with 4 subsection slots"
    - path: "components/how-you-earn/shared/isometric-utils.ts"
      provides: "Isometric coordinate transform functions"
    - path: "components/how-you-earn/shared/odometer.tsx"
      provides: "Reusable animated number counter component"
    - path: "components/how-you-earn/shared/scroll-section.tsx"
      provides: "Reusable scroll-triggered section wrapper"
---

<objective>
Delete the old "How It Works" implementation and create fresh infrastructure for the new "How You Earn" 4-section design.

Purpose: Clean slate for premium isometric animations
Output: New directory structure, shared utilities, placeholder sections
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-how-it-works/07-RESEARCH-v2.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete old how-it-works components</name>
  <files>components/how-it-works/*</files>
  <action>
Delete the entire `components/how-it-works/` directory and all its contents:
- how-it-works-section.tsx
- how-it-works-static.tsx
- payment-flow-animation.tsx
- progress-dots.tsx

Use `rm -rf components/how-it-works/`

This removes all the deprecated v1 implementation.
  </action>
  <verify>
1. Run `ls components/how-it-works/` - should error "No such file or directory"
2. Run `npm run build` - will have import errors (expected, fixed in Task 4)
  </verify>
  <done>
Old how-it-works directory deleted
  </done>
</task>

<task type="auto">
  <name>Task 2: Create how-you-earn directory structure</name>
  <files>components/how-you-earn/*</files>
  <action>
Create the new directory structure:

```bash
mkdir -p components/how-you-earn/tuition-rewards
mkdir -p components/how-you-earn/unlock-rate
mkdir -p components/how-you-earn/discover-rewards
mkdir -p components/how-you-earn/rewards-loop
mkdir -p components/how-you-earn/shared
```

Create the barrel export `components/how-you-earn/index.ts`:
```typescript
export { HowYouEarnSection } from './how-you-earn-section'
```
  </action>
  <verify>
1. Run `ls -la components/how-you-earn/` - shows subdirectories
2. File index.ts exists
  </verify>
  <done>
New directory structure created with barrel export
  </done>
</task>

<task type="auto">
  <name>Task 3: Create shared utilities</name>
  <files>components/how-you-earn/shared/*</files>
  <action>
Create three shared utility files:

**1. `components/how-you-earn/shared/constants.ts`**
```typescript
// Isometric color palette (extending brand tokens)
export const ISO_COLORS = {
  // Primary (from brand)
  primary: 'oklch(0.65 0.25 260)',
  primaryLight: 'oklch(0.80 0.15 260)',
  primaryDark: 'oklch(0.45 0.20 260)',

  // Surfaces for isometric faces
  surfaceTop: 'oklch(0.98 0.01 260)',
  surfaceLeft: 'oklch(0.90 0.02 260)',
  surfaceRight: 'oklch(0.85 0.02 260)',

  // Accents
  success: 'oklch(0.70 0.20 145)',
  amber: 'oklch(0.75 0.15 85)',
  blue: 'oklch(0.65 0.20 240)',

  // Shadow
  shadow: 'oklch(0.20 0.05 260 / 0.15)',
} as const

// Animation timing
export const TIMING = {
  stagger: 0.1,
  duration: {
    fast: 0.3,
    normal: 0.5,
    slow: 0.8,
  },
  spring: {
    stiff: { type: 'spring', stiffness: 300, damping: 30 },
    bouncy: { type: 'spring', stiffness: 400, damping: 25 },
    smooth: { type: 'spring', stiffness: 200, damping: 40 },
  },
} as const

// Example numbers used in animations
export const EXAMPLE_DATA = {
  tuition: 25000,
  rewardRate: 0.01, // 1%
  rewardAmount: 250, // 1% of 25k
  thresholds: {
    tier1: { spend: 0.20, rate: 0.005 }, // 20% spend → 0.5% rate
    tier2: { spend: 0.40, rate: 0.01 },  // 40% spend → 1.0% rate
  },
  merchantMultipliers: [3, 5, 7, 10],
  totalPoints: 12450,
  pointValue: 0.01, // 1 point = $0.01
} as const
```

**2. `components/how-you-earn/shared/isometric-utils.ts`**
```typescript
/**
 * Isometric projection utilities
 * Standard 30° isometric angle (2:1 pixel ratio)
 */

const ISO_ANGLE = Math.PI / 6 // 30 degrees

/**
 * Convert 3D coordinates to 2D isometric projection
 */
export function toIsometric(x: number, y: number, z: number = 0): { x: number; y: number } {
  const isoX = (x - z) * Math.cos(ISO_ANGLE)
  const isoY = (x + z) * Math.sin(ISO_ANGLE) - y
  return { x: isoX, y: isoY }
}

/**
 * Generate SVG transform attribute for isometric positioning
 */
export function isometricTransform(x: number, y: number, z: number = 0): string {
  const iso = toIsometric(x, y, z)
  return `translate(${iso.x}, ${iso.y})`
}

/**
 * Create isometric box face paths
 * Returns paths for top, left, and right faces of a box
 */
export function createIsometricBox(
  width: number,
  height: number,
  depth: number,
  originX: number = 0,
  originY: number = 0
): {
  top: string
  left: string
  right: string
} {
  // Calculate corner points
  const w = width * Math.cos(ISO_ANGLE)
  const d = depth * Math.cos(ISO_ANGLE)
  const h = height
  const wY = width * Math.sin(ISO_ANGLE)
  const dY = depth * Math.sin(ISO_ANGLE)

  // Top face (parallelogram)
  const top = `M ${originX} ${originY - h}
    L ${originX + w} ${originY - h + wY}
    L ${originX + w - d} ${originY - h + wY + dY}
    L ${originX - d} ${originY - h + dY}
    Z`

  // Left face
  const left = `M ${originX} ${originY - h}
    L ${originX - d} ${originY - h + dY}
    L ${originX - d} ${originY + dY}
    L ${originX} ${originY}
    Z`

  // Right face
  const right = `M ${originX} ${originY - h}
    L ${originX + w} ${originY - h + wY}
    L ${originX + w} ${originY + wY}
    L ${originX} ${originY}
    Z`

  return { top, left, right }
}

/**
 * Generate points for an isometric grid
 */
export function createIsometricGrid(
  rows: number,
  cols: number,
  cellSize: number,
  originX: number = 0,
  originY: number = 0
): Array<{ x: number; y: number; row: number; col: number }> {
  const points: Array<{ x: number; y: number; row: number; col: number }> = []

  for (let row = 0; row < rows; row++) {
    for (let col = 0; col < cols; col++) {
      const iso = toIsometric(col * cellSize, 0, row * cellSize)
      points.push({
        x: originX + iso.x,
        y: originY + iso.y,
        row,
        col,
      })
    }
  }

  return points
}
```

**3. `components/how-you-earn/shared/scroll-section.tsx`**
```typescript
'use client'

import { motion, useScroll, useTransform, MotionValue } from 'framer-motion'
import { useRef, ReactNode } from 'react'
import { useReducedMotion } from 'framer-motion'

interface ScrollSectionProps {
  children: (progress: MotionValue<number>) => ReactNode
  fallback?: ReactNode
  className?: string
  id?: string
}

/**
 * Reusable scroll-animated section wrapper
 * Provides scroll progress (0-1) to children for coordinated animations
 */
export function ScrollSection({
  children,
  fallback,
  className = '',
  id,
}: ScrollSectionProps) {
  const ref = useRef<HTMLElement>(null)
  const prefersReducedMotion = useReducedMotion()

  const { scrollYProgress } = useScroll({
    target: ref,
    offset: ['start end', 'end start'], // Track from entering to leaving viewport
  })

  // If reduced motion, render fallback or static version
  if (prefersReducedMotion && fallback) {
    return (
      <section id={id} className={className}>
        {fallback}
      </section>
    )
  }

  return (
    <section ref={ref} id={id} className={`min-h-screen relative ${className}`}>
      {children(scrollYProgress)}
    </section>
  )
}

/**
 * Hook for creating scroll-linked transforms within a section
 */
export function useScrollTransform(
  progress: MotionValue<number>,
  inputRange: number[],
  outputRange: number[] | string[]
) {
  return useTransform(progress, inputRange, outputRange)
}
```
  </action>
  <verify>
1. All three files exist in components/how-you-earn/shared/
2. No TypeScript errors: `npx tsc --noEmit` (or check in IDE)
  </verify>
  <done>
Shared utilities created: constants, isometric-utils, scroll-section
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Odometer component</name>
  <files>components/how-you-earn/shared/odometer.tsx</files>
  <action>
Create a reusable animated number counter component:

**`components/how-you-earn/shared/odometer.tsx`**
```typescript
'use client'

import { motion, useSpring, useTransform, MotionValue } from 'framer-motion'
import { useEffect, useRef } from 'react'

interface OdometerProps {
  value: number
  /** If provided, animate based on scroll progress instead of on mount */
  progress?: MotionValue<number>
  /** Range of progress where animation happens [start, end] */
  progressRange?: [number, number]
  /** Format the number (e.g., add $ prefix, commas) */
  format?: (value: number) => string
  /** CSS class for the container */
  className?: string
  /** Duration in seconds (ignored if progress-driven) */
  duration?: number
}

/**
 * Animated number counter with odometer-style digit animation
 * Can be driven by scroll progress or animate on mount
 */
export function Odometer({
  value,
  progress,
  progressRange = [0, 1],
  format = (v) => v.toLocaleString(),
  className = '',
  duration = 1.5,
}: OdometerProps) {
  // Spring for mount-based animation
  const spring = useSpring(0, {
    stiffness: 100,
    damping: 30,
    duration: duration,
  })

  // If progress-driven, map progress to value
  const progressValue = useTransform(
    progress ?? spring,
    progress ? progressRange : [0, 1],
    [0, value]
  )

  // Round and format the animated value
  const displayValue = useTransform(progressValue, (v) => format(Math.round(v)))

  // Trigger spring animation on mount (if not progress-driven)
  useEffect(() => {
    if (!progress) {
      spring.set(1)
    }
  }, [spring, progress, value])

  return (
    <motion.span className={`tabular-nums ${className}`}>
      {displayValue}
    </motion.span>
  )
}

/**
 * Odometer with dollar formatting
 */
export function DollarOdometer(props: Omit<OdometerProps, 'format'>) {
  return (
    <Odometer
      {...props}
      format={(v) => `$${v.toLocaleString()}`}
    />
  )
}

/**
 * Odometer with percentage formatting
 */
export function PercentOdometer(props: Omit<OdometerProps, 'format'> & { decimals?: number }) {
  const { decimals = 1, ...rest } = props
  return (
    <Odometer
      {...props}
      format={(v) => `${v.toFixed(decimals)}%`}
    />
  )
}

/**
 * Odometer with points formatting (e.g., "12,450 pts")
 */
export function PointsOdometer(props: Omit<OdometerProps, 'format'>) {
  return (
    <Odometer
      {...props}
      format={(v) => `${v.toLocaleString()} pts`}
    />
  )
}
```
  </action>
  <verify>
1. File exists at components/how-you-earn/shared/odometer.tsx
2. Exports Odometer, DollarOdometer, PercentOdometer, PointsOdometer
  </verify>
  <done>
Odometer component created with dollar, percent, and points variants
  </done>
</task>

<task type="auto">
  <name>Task 5: Create main section wrapper with placeholders</name>
  <files>components/how-you-earn/how-you-earn-section.tsx</files>
  <action>
Create the main section wrapper that will contain all 4 subsections:

**`components/how-you-earn/how-you-earn-section.tsx`**
```typescript
'use client'

import { useReducedMotion } from 'framer-motion'

// Placeholder components - will be replaced in subsequent plans
function TuitionRewardsPlaceholder() {
  return (
    <section className="min-h-screen flex items-center justify-center bg-gradient-to-b from-background to-muted/30">
      <div className="text-center p-8">
        <h2 className="text-3xl font-bold mb-4">Earn on Every Tuition Payment</h2>
        <p className="text-muted-foreground">Animation coming in 07-06</p>
      </div>
    </section>
  )
}

function UnlockRatePlaceholder() {
  return (
    <section className="min-h-screen flex items-center justify-center bg-gradient-to-b from-muted/30 to-background">
      <div className="text-center p-8">
        <h2 className="text-3xl font-bold mb-4">Unlock Better Tuition Rates</h2>
        <p className="text-muted-foreground">Animation coming in 07-07</p>
      </div>
    </section>
  )
}

function DiscoverRewardsPlaceholder() {
  return (
    <section className="min-h-screen flex items-center justify-center bg-gradient-to-b from-background to-muted/30">
      <div className="text-center p-8">
        <h2 className="text-3xl font-bold mb-4">Discover Local Rewards</h2>
        <p className="text-muted-foreground">Animation coming in 07-08</p>
      </div>
    </section>
  )
}

function RewardsLoopPlaceholder() {
  return (
    <section className="min-h-screen flex items-center justify-center bg-gradient-to-b from-muted/30 to-background">
      <div className="text-center p-8">
        <h2 className="text-3xl font-bold mb-4">Redeem & Repeat</h2>
        <p className="text-muted-foreground">Animation coming in 07-09</p>
      </div>
    </section>
  )
}

/**
 * Static fallback for reduced motion users
 */
function HowYouEarnStatic() {
  return (
    <div className="py-24 space-y-24">
      <section className="container mx-auto px-4 text-center">
        <h2 className="text-3xl font-bold mb-4">Earn on Every Tuition Payment</h2>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          Pay your $25,000 tuition through Omni. We handle the ACH transfer
          to your school — you earn up to 1% back. That's $250 in rewards.
        </p>
      </section>

      <section className="container mx-auto px-4 text-center">
        <h2 className="text-3xl font-bold mb-4">Unlock Better Tuition Rates</h2>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          Use your Omni card for everyday purchases. Spend 20% of tuition to
          unlock 0.5% back. Spend 40% to unlock 1.0% back.
        </p>
      </section>

      <section className="container mx-auto px-4 text-center">
        <h2 className="text-3xl font-bold mb-4">Discover Local Rewards</h2>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          Find participating merchants near campus through the Omni app.
          Earn 3x to 10x points at select locations.
        </p>
      </section>

      <section className="container mx-auto px-4 text-center">
        <h2 className="text-3xl font-bold mb-4">Redeem & Repeat</h2>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          Your points work toward what matters most — reducing your next
          tuition bill. Then earn more the following semester.
        </p>
      </section>
    </div>
  )
}

/**
 * Main "How You Earn" section containing 4 animated subsections
 */
export function HowYouEarnSection() {
  const prefersReducedMotion = useReducedMotion()

  if (prefersReducedMotion) {
    return <HowYouEarnStatic />
  }

  return (
    <div id="how-it-works">
      <TuitionRewardsPlaceholder />
      <UnlockRatePlaceholder />
      <DiscoverRewardsPlaceholder />
      <RewardsLoopPlaceholder />
    </div>
  )
}
```
  </action>
  <verify>
1. File exists at components/how-you-earn/how-you-earn-section.tsx
2. Exports HowYouEarnSection component
3. Has reduced motion fallback
  </verify>
  <done>
Main section wrapper created with 4 placeholder subsections and reduced motion fallback
  </done>
</task>

<task type="auto">
  <name>Task 6: Update page.tsx to use new component</name>
  <files>app/page.tsx</files>
  <action>
Update the main page to import and use the new HowYouEarnSection:

1. Find the import for the old how-it-works component (likely `HowItWorksSection` from `@/components/how-it-works/how-it-works-section`)
2. Replace with: `import { HowYouEarnSection } from '@/components/how-you-earn'`
3. Replace `<HowItWorksSection />` with `<HowYouEarnSection />`

If the old component was named differently, adjust accordingly. The section should be positioned after the Hero and before the next content section.
  </action>
  <verify>
1. Run `npm run build` - should complete without errors
2. Run `npm run dev` and visit localhost:3000
3. Scroll down - should see 4 placeholder sections with titles
4. Reduced motion users see static content (test in browser devtools)
  </verify>
  <done>
Page updated to use new HowYouEarnSection component, build passes
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Structure verification:**
   - `ls components/how-it-works/` returns "No such file or directory"
   - `ls components/how-you-earn/` shows: index.ts, how-you-earn-section.tsx, shared/, tuition-rewards/, unlock-rate/, discover-rewards/, rewards-loop/

2. **Build verification:**
   - `npm run build` completes without errors
   - No TypeScript errors

3. **Visual verification:**
   - Page loads with 4 placeholder sections
   - Each section is full-height (min-h-screen)
   - Alternating gradient backgrounds
   - Reduced motion shows static content

4. **Utility verification:**
   - isometric-utils.ts exports toIsometric, isometricTransform, createIsometricBox, createIsometricGrid
   - odometer.tsx exports Odometer, DollarOdometer, PercentOdometer, PointsOdometer
   - scroll-section.tsx exports ScrollSection, useScrollTransform
</verification>

<success_criteria>
- Old how-it-works directory deleted
- New how-you-earn directory structure created
- Shared utilities (constants, isometric-utils, scroll-section, odometer) implemented
- Main section wrapper with placeholders working
- Page renders with new component
- Build passes
- Reduced motion fallback works
</success_criteria>

<output>
After completion, create `.planning/phases/07-how-it-works/07-05-SUMMARY.md`
</output>
