---
phase: 07-how-it-works
plan: 09
type: execute
wave: 2
depends_on: [07-05]
files_modified: [components/how-you-earn/rewards-loop/*, components/how-you-earn/how-you-earn-section.tsx]
autonomous: true

must_haves:
  truths:
    - "User sees total points badge with animated counter"
    - "User sees three source categories (tuition, everyday, merchants)"
    - "User sees animated flow lines from sources to tuition card"
    - "User sees tuition amount reduce from $25,000 to $24,875.50"
    - "User sees loop/repeat visual indicating the cycle continues"
  artifacts:
    - path: "components/how-you-earn/rewards-loop/rewards-loop.tsx"
      provides: "Main section component with flow diagram animation"
    - path: "components/how-you-earn/rewards-loop/points-badge.tsx"
      provides: "Central points total display with counter"
    - path: "components/how-you-earn/rewards-loop/flow-diagram.tsx"
      provides: "Animated SVG flow lines from sources"
    - path: "components/how-you-earn/rewards-loop/tuition-card.tsx"
      provides: "Isometric tuition bill with reduction animation"
    - path: "components/how-you-earn/rewards-loop/loop-indicator.tsx"
      provides: "Circular arrow showing cycle repeats"
---

<objective>
Build the "Redeem & Repeat" section showing how points combine and reduce the next tuition bill.

Purpose: Close the loop ‚Äî show the virtuous cycle of earning and redeeming
Output: Flow diagram with points aggregation and tuition reduction animation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-how-it-works/07-RESEARCH-v2.md

# Dependencies from 07-05
@components/how-you-earn/shared/constants.ts
@components/how-you-earn/shared/odometer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create points badge component</name>
  <files>components/how-you-earn/rewards-loop/points-badge.tsx</files>
  <action>
Create the central points total display:

**`components/how-you-earn/rewards-loop/points-badge.tsx`**
```typescript
'use client'

import { motion, MotionValue, useTransform } from 'framer-motion'
import { PointsOdometer } from '../shared/odometer'
import { EXAMPLE_DATA } from '../shared/constants'

interface PointsBadgeProps {
  progress?: MotionValue<number>
  /** Progress range when badge appears and counter runs */
  appearRange?: [number, number]
  className?: string
}

/**
 * Central points badge showing total accumulated points
 */
export function PointsBadge({
  progress,
  appearRange = [0.1, 0.3],
  className = '',
}: PointsBadgeProps) {
  const opacity = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [appearRange[0], appearRange[0] + 0.05],
    [0, 1]
  )

  const scale = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [appearRange[0], appearRange[0] + 0.05, appearRange[0] + 0.1],
    [0.8, 1.05, 1]
  )

  return (
    <motion.div
      className={`text-center ${className}`}
      style={{ opacity, scale }}
    >
      {/* Badge container */}
      <div className="inline-block bg-gradient-to-br from-primary/20 to-amber-500/20 rounded-2xl p-6 md:p-8 border border-primary/30 shadow-xl">
        <div className="text-sm text-muted-foreground mb-2 uppercase tracking-wide">
          Your Points
        </div>

        <div className="text-4xl md:text-5xl lg:text-6xl font-bold text-foreground">
          <PointsOdometer
            value={EXAMPLE_DATA.totalPoints}
            progress={progress}
            progressRange={appearRange}
          />
        </div>

        <div className="text-sm text-muted-foreground mt-2">
          combined from all sources
        </div>
      </div>
    </motion.div>
  )
}
```
  </action>
  <verify>
1. File exists at components/how-you-earn/rewards-loop/points-badge.tsx
2. No TypeScript errors
  </verify>
  <done>
Points badge component created with animated counter
  </done>
</task>

<task type="auto">
  <name>Task 2: Create source breakdown component</name>
  <files>components/how-you-earn/rewards-loop/source-breakdown.tsx</files>
  <action>
Create the three source categories display:

**`components/how-you-earn/rewards-loop/source-breakdown.tsx`**
```typescript
'use client'

import { motion, MotionValue, useTransform } from 'framer-motion'
import { Odometer } from '../shared/odometer'

interface SourceBreakdownProps {
  progress?: MotionValue<number>
  /** Progress range when sources appear */
  appearRange?: [number, number]
  className?: string
}

const SOURCES = [
  {
    id: 'tuition',
    label: 'Tuition',
    icon: 'üéì',
    points: 250,
    color: 'oklch(0.65 0.25 260)',
  },
  {
    id: 'everyday',
    label: 'Everyday',
    icon: 'üí≥',
    points: 8200,
    color: 'oklch(0.65 0.20 240)',
  },
  {
    id: 'merchants',
    label: 'Merchants',
    icon: 'üè™',
    points: 4000,
    color: 'oklch(0.75 0.15 85)',
  },
] as const

/**
 * Three source categories showing where points came from
 */
export function SourceBreakdown({
  progress,
  appearRange = [0.35, 0.55],
  className = '',
}: SourceBreakdownProps) {
  return (
    <div className={`flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8 ${className}`}>
      {SOURCES.map((source, i) => {
        const itemStart = appearRange[0] + i * 0.05
        const itemEnd = itemStart + 0.1

        return (
          <motion.div
            key={source.id}
            className="flex flex-col items-center"
            style={{
              opacity: useTransform(
                progress ?? { get: () => 1 } as MotionValue<number>,
                [itemStart, itemStart + 0.03],
                [0, 1]
              ),
              y: useTransform(
                progress ?? { get: () => 1 } as MotionValue<number>,
                [itemStart, itemStart + 0.05],
                [20, 0]
              ),
            }}
          >
            {/* Icon */}
            <div
              className="w-12 h-12 rounded-full flex items-center justify-center text-2xl mb-2 shadow-md"
              style={{ backgroundColor: `${source.color}20` }}
            >
              {source.icon}
            </div>

            {/* Points */}
            <div className="text-lg font-bold" style={{ color: source.color }}>
              +<Odometer
                value={source.points}
                progress={progress}
                progressRange={[itemStart, itemEnd]}
                format={(v) => v.toLocaleString()}
              />
            </div>

            {/* Label */}
            <div className="text-xs text-muted-foreground">
              {source.label}
            </div>
          </motion.div>
        )
      })}
    </div>
  )
}

export { SOURCES }
```
  </action>
  <verify>
1. File exists at components/how-you-earn/rewards-loop/source-breakdown.tsx
2. No TypeScript errors
  </verify>
  <done>
Source breakdown component created with three animated categories
  </done>
</task>

<task type="auto">
  <name>Task 3: Create tuition card component</name>
  <files>components/how-you-earn/rewards-loop/tuition-card.tsx</files>
  <action>
Create the isometric tuition bill with reduction animation:

**`components/how-you-earn/rewards-loop/tuition-card.tsx`**
```typescript
'use client'

import { motion, MotionValue, useTransform } from 'framer-motion'
import { DollarOdometer } from '../shared/odometer'
import { EXAMPLE_DATA } from '../shared/constants'

interface TuitionCardProps {
  progress?: MotionValue<number>
  /** Progress range when card appears */
  appearRange?: [number, number]
  /** Progress range when reduction animates */
  reductionRange?: [number, number]
  className?: string
}

/**
 * Tuition bill card showing reduction when points applied
 */
export function TuitionCard({
  progress,
  appearRange = [0.55, 0.65],
  reductionRange = [0.7, 0.85],
  className = '',
}: TuitionCardProps) {
  const cardOpacity = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [appearRange[0], appearRange[0] + 0.05],
    [0, 1]
  )

  const cardY = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [appearRange[0], appearRange[1]],
    [30, 0]
  )

  // Reduction animation
  const reductionOpacity = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [reductionRange[0], reductionRange[0] + 0.05],
    [0, 1]
  )

  const reductionScale = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [reductionRange[0], reductionRange[0] + 0.05, reductionRange[0] + 0.1],
    [0.8, 1.1, 1]
  )

  // Calculate reduction
  const reduction = EXAMPLE_DATA.totalPoints * EXAMPLE_DATA.pointValue
  const newTotal = EXAMPLE_DATA.tuition - reduction

  return (
    <motion.div
      className={`${className}`}
      style={{ opacity: cardOpacity, y: cardY }}
    >
      {/* Card container with slight 3D tilt */}
      <div
        className="bg-background border border-border rounded-xl shadow-xl p-6 md:p-8 max-w-sm mx-auto"
        style={{
          transform: 'perspective(1000px) rotateY(-5deg) rotateX(5deg)',
        }}
      >
        {/* Header */}
        <div className="flex items-center justify-between mb-4">
          <span className="text-sm font-medium text-muted-foreground">
            NEXT SEMESTER
          </span>
          <span className="text-xs bg-muted px-2 py-0.5 rounded">
            Spring 2026
          </span>
        </div>

        {/* Original amount */}
        <div className="relative">
          <div className="text-2xl md:text-3xl font-bold text-muted-foreground">
            ${EXAMPLE_DATA.tuition.toLocaleString()}
          </div>

          {/* Strikethrough line */}
          <motion.div
            className="absolute left-0 top-1/2 h-0.5 bg-red-400"
            style={{
              width: useTransform(
                progress ?? { get: () => 1 } as MotionValue<number>,
                [reductionRange[0] + 0.05, reductionRange[0] + 0.1],
                ['0%', '100%']
              ),
            }}
          />
        </div>

        {/* New amount with reduction */}
        <motion.div
          className="mt-4"
          style={{ opacity: reductionOpacity, scale: reductionScale }}
        >
          {/* New total */}
          <div className="text-3xl md:text-4xl font-bold text-foreground">
            <DollarOdometer
              value={newTotal}
              progress={progress}
              progressRange={reductionRange}
            />
          </div>

          {/* Savings badge */}
          <motion.div
            className="inline-flex items-center gap-2 mt-3 px-3 py-1.5 bg-green-100 text-green-700 rounded-full"
            style={{
              opacity: useTransform(
                progress ?? { get: () => 1 } as MotionValue<number>,
                [reductionRange[1] - 0.05, reductionRange[1]],
                [0, 1]
              ),
              scale: useTransform(
                progress ?? { get: () => 1 } as MotionValue<number>,
                [reductionRange[1] - 0.05, reductionRange[1]],
                [0.8, 1]
              ),
            }}
          >
            <span className="text-lg">‚úì</span>
            <span className="font-bold">${reduction.toFixed(2)} OFF</span>
          </motion.div>
        </motion.div>

        {/* Footer */}
        <div className="mt-4 pt-4 border-t border-border">
          <div className="text-xs text-muted-foreground">
            Points applied automatically at checkout
          </div>
        </div>
      </div>
    </motion.div>
  )
}
```
  </action>
  <verify>
1. File exists at components/how-you-earn/rewards-loop/tuition-card.tsx
2. No TypeScript errors
  </verify>
  <done>
Tuition card component created with reduction animation and savings badge
  </done>
</task>

<task type="auto">
  <name>Task 4: Create loop indicator component</name>
  <files>components/how-you-earn/rewards-loop/loop-indicator.tsx</files>
  <action>
Create the circular arrow showing the cycle continues:

**`components/how-you-earn/rewards-loop/loop-indicator.tsx`**
```typescript
'use client'

import { motion, MotionValue, useTransform } from 'framer-motion'

interface LoopIndicatorProps {
  progress?: MotionValue<number>
  /** Progress range when loop appears */
  appearRange?: [number, number]
  className?: string
}

/**
 * Circular arrow indicating the rewards cycle continues
 */
export function LoopIndicator({
  progress,
  appearRange = [0.85, 0.95],
  className = '',
}: LoopIndicatorProps) {
  const opacity = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [appearRange[0], appearRange[0] + 0.05],
    [0, 1]
  )

  const y = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [appearRange[0], appearRange[1]],
    [20, 0]
  )

  // Arrow rotation animation
  const rotate = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [appearRange[0], appearRange[1]],
    [-90, 0]
  )

  return (
    <motion.div
      className={`text-center ${className}`}
      style={{ opacity, y }}
    >
      {/* Circular arrow */}
      <motion.div
        className="inline-block mb-3"
        style={{ rotate }}
      >
        <svg
          viewBox="0 0 60 60"
          className="w-12 h-12 md:w-16 md:h-16"
        >
          {/* Circular path */}
          <circle
            cx="30"
            cy="30"
            r="24"
            fill="none"
            stroke="oklch(0.65 0.25 260 / 0.3)"
            strokeWidth="4"
          />

          {/* Animated arc */}
          <motion.circle
            cx="30"
            cy="30"
            r="24"
            fill="none"
            stroke="oklch(0.65 0.25 260)"
            strokeWidth="4"
            strokeLinecap="round"
            strokeDasharray="120"
            style={{
              strokeDashoffset: useTransform(
                progress ?? { get: () => 1 } as MotionValue<number>,
                [appearRange[0] + 0.05, appearRange[1]],
                [120, 30]
              ),
            }}
            transform="rotate(-90 30 30)"
          />

          {/* Arrow head */}
          <motion.path
            d="M 50 15 L 56 30 L 50 30"
            fill="none"
            stroke="oklch(0.65 0.25 260)"
            strokeWidth="4"
            strokeLinecap="round"
            strokeLinejoin="round"
            style={{
              opacity: useTransform(
                progress ?? { get: () => 1 } as MotionValue<number>,
                [appearRange[1] - 0.05, appearRange[1]],
                [0, 1]
              ),
            }}
          />
        </svg>
      </motion.div>

      {/* Text */}
      <div className="bg-muted/50 rounded-full px-4 py-2 inline-block">
        <span className="text-sm font-medium text-muted-foreground">
          Earn more next semester
        </span>
      </div>
    </motion.div>
  )
}
```
  </action>
  <verify>
1. File exists at components/how-you-earn/rewards-loop/loop-indicator.tsx
2. No TypeScript errors
  </verify>
  <done>
Loop indicator component created with animated circular arrow
  </done>
</task>

<task type="auto">
  <name>Task 5: Create flow lines SVG component</name>
  <files>components/how-you-earn/rewards-loop/flow-lines.tsx</files>
  <action>
Create animated lines connecting sources to tuition:

**`components/how-you-earn/rewards-loop/flow-lines.tsx`**
```typescript
'use client'

import { motion, MotionValue, useTransform } from 'framer-motion'

interface FlowLinesProps {
  progress?: MotionValue<number>
  /** Progress range when lines draw */
  drawRange?: [number, number]
  className?: string
}

/**
 * Animated SVG lines showing points flowing to tuition
 */
export function FlowLines({
  progress,
  drawRange = [0.5, 0.65],
  className = '',
}: FlowLinesProps) {
  const opacity = useTransform(
    progress ?? { get: () => 1 } as MotionValue<number>,
    [drawRange[0], drawRange[0] + 0.02],
    [0, 1]
  )

  return (
    <motion.svg
      viewBox="0 0 300 100"
      className={`w-full max-w-sm mx-auto ${className}`}
      style={{ opacity }}
      preserveAspectRatio="xMidYMid meet"
    >
      <defs>
        {/* Gradient for flow lines */}
        <linearGradient id="flowGradientLoop" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stopColor="oklch(0.65 0.25 260)" />
          <stop offset="100%" stopColor="oklch(0.70 0.20 145)" />
        </linearGradient>
      </defs>

      {/* Left line (from tuition source) */}
      <motion.path
        d="M 50 0 Q 50 50, 150 80"
        fill="none"
        stroke="url(#flowGradientLoop)"
        strokeWidth="2"
        strokeLinecap="round"
        strokeDasharray="150"
        style={{
          strokeDashoffset: useTransform(
            progress ?? { get: () => 1 } as MotionValue<number>,
            [drawRange[0], drawRange[0] + 0.08],
            [150, 0]
          ),
        }}
      />

      {/* Center line (from everyday source) */}
      <motion.path
        d="M 150 0 L 150 80"
        fill="none"
        stroke="url(#flowGradientLoop)"
        strokeWidth="2"
        strokeLinecap="round"
        strokeDasharray="80"
        style={{
          strokeDashoffset: useTransform(
            progress ?? { get: () => 1 } as MotionValue<number>,
            [drawRange[0] + 0.03, drawRange[0] + 0.1],
            [80, 0]
          ),
        }}
      />

      {/* Right line (from merchants source) */}
      <motion.path
        d="M 250 0 Q 250 50, 150 80"
        fill="none"
        stroke="url(#flowGradientLoop)"
        strokeWidth="2"
        strokeLinecap="round"
        strokeDasharray="150"
        style={{
          strokeDashoffset: useTransform(
            progress ?? { get: () => 1 } as MotionValue<number>,
            [drawRange[0] + 0.05, drawRange[0] + 0.13],
            [150, 0]
          ),
        }}
      />

      {/* Arrow at bottom */}
      <motion.path
        d="M 145 90 L 150 100 L 155 90"
        fill="none"
        stroke="oklch(0.70 0.20 145)"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        style={{
          opacity: useTransform(
            progress ?? { get: () => 1 } as MotionValue<number>,
            [drawRange[1] - 0.02, drawRange[1]],
            [0, 1]
          ),
        }}
      />
    </motion.svg>
  )
}
```
  </action>
  <verify>
1. File exists at components/how-you-earn/rewards-loop/flow-lines.tsx
2. No TypeScript errors
  </verify>
  <done>
Flow lines SVG component created with animated path drawing
  </done>
</task>

<task type="auto">
  <name>Task 6: Create main RewardsLoop section</name>
  <files>components/how-you-earn/rewards-loop/rewards-loop.tsx, components/how-you-earn/rewards-loop/index.ts</files>
  <action>
Create the main section component:

**`components/how-you-earn/rewards-loop/rewards-loop.tsx`**
```typescript
'use client'

import { useRef } from 'react'
import { useScroll, motion, useTransform } from 'framer-motion'
import { PointsBadge } from './points-badge'
import { SourceBreakdown } from './source-breakdown'
import { FlowLines } from './flow-lines'
import { TuitionCard } from './tuition-card'
import { LoopIndicator } from './loop-indicator'

/**
 * Section 4: Redeem & Repeat
 *
 * Shows how points from all sources combine and reduce the next tuition bill
 * Demonstrates the virtuous cycle of earning and redeeming
 */
export function RewardsLoop() {
  const sectionRef = useRef<HTMLElement>(null)

  const { scrollYProgress } = useScroll({
    target: sectionRef,
    offset: ['start end', 'end start'],
  })

  // Map scroll to animation progress
  const animationProgress = useTransform(
    scrollYProgress,
    [0.1, 0.75],
    [0, 1]
  )

  return (
    <section
      ref={sectionRef}
      className="min-h-screen py-24 md:py-32 flex flex-col items-center justify-center relative overflow-hidden"
    >
      {/* Background */}
      <div className="absolute inset-0 bg-gradient-to-b from-muted/30 via-background to-primary/5 pointer-events-none" />

      <div className="container mx-auto px-4 relative z-10">
        {/* Header */}
        <motion.div
          className="text-center mb-8 md:mb-12"
          style={{
            opacity: useTransform(animationProgress, [0, 0.08], [0, 1]),
            y: useTransform(animationProgress, [0, 0.08], [30, 0]),
          }}
        >
          <h2 className="text-3xl md:text-4xl lg:text-5xl font-bold mb-4">
            Redeem & Repeat
          </h2>
          <p className="text-muted-foreground text-lg md:text-xl max-w-2xl mx-auto">
            Your points work toward what matters most ‚Äî
            reducing your next tuition bill.
          </p>
        </motion.div>

        {/* Points badge */}
        <PointsBadge
          progress={animationProgress}
          appearRange={[0.1, 0.3]}
        />

        {/* Source breakdown */}
        <div className="mt-8">
          <SourceBreakdown
            progress={animationProgress}
            appearRange={[0.3, 0.5]}
          />
        </div>

        {/* Flow lines */}
        <div className="my-4">
          <FlowLines
            progress={animationProgress}
            drawRange={[0.45, 0.6]}
          />
        </div>

        {/* Tuition card */}
        <TuitionCard
          progress={animationProgress}
          appearRange={[0.55, 0.65]}
          reductionRange={[0.65, 0.8]}
        />

        {/* Loop indicator */}
        <div className="mt-8">
          <LoopIndicator
            progress={animationProgress}
            appearRange={[0.8, 0.95]}
          />
        </div>
      </div>
    </section>
  )
}
```

**`components/how-you-earn/rewards-loop/index.ts`**
```typescript
export { RewardsLoop } from './rewards-loop'
export { PointsBadge } from './points-badge'
export { SourceBreakdown } from './source-breakdown'
export { FlowLines } from './flow-lines'
export { TuitionCard } from './tuition-card'
export { LoopIndicator } from './loop-indicator'
```
  </action>
  <verify>
1. Both files exist
2. RewardsLoop exports correctly
3. No TypeScript errors
  </verify>
  <done>
Main RewardsLoop section created with all components composed
  </done>
</task>

<task type="auto">
  <name>Task 7: Integrate into HowYouEarnSection and cleanup</name>
  <files>components/how-you-earn/how-you-earn-section.tsx</files>
  <action>
Update the main section to use all real components:

1. Add import: `import { RewardsLoop } from './rewards-loop'`
2. Replace `<RewardsLoopPlaceholder />` with `<RewardsLoop />`
3. Remove all placeholder functions (no longer needed)
4. Clean up imports

The final component should render:
- TuitionRewards
- UnlockRate
- DiscoverRewards
- RewardsLoop

All four sections are now real implementations.
  </action>
  <verify>
1. Run `npm run build` - should pass
2. Run `npm run dev`
3. Visit localhost:3000 and scroll through ALL four "How You Earn" sections
4. Verify complete flow:
   - Section 1: Bank ‚Üí ACH ‚Üí School ‚Üí $250 rewards
   - Section 2: Progress bar fills, thresholds unlock, rate changes
   - Section 3: Map appears, pins bounce in, notification slides up
   - Section 4: Points badge, sources, flow lines, tuition reduction, loop
5. Test reduced motion - should show static content
  </verify>
  <done>
All four sections integrated, complete How You Earn experience working
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **File structure:**
   - components/how-you-earn/rewards-loop/index.ts
   - components/how-you-earn/rewards-loop/rewards-loop.tsx
   - components/how-you-earn/rewards-loop/points-badge.tsx
   - components/how-you-earn/rewards-loop/source-breakdown.tsx
   - components/how-you-earn/rewards-loop/flow-lines.tsx
   - components/how-you-earn/rewards-loop/tuition-card.tsx
   - components/how-you-earn/rewards-loop/loop-indicator.tsx

2. **Visual verification:**
   - Points badge appears with counter (12,450)
   - Three source categories show with their amounts
   - Flow lines draw from sources to tuition
   - Tuition shows $25,000 ‚Üí $24,875.50
   - Savings badge pops with "$124.50 OFF"
   - Loop arrow animates with "Earn more next semester"

3. **Complete flow test:**
   - All 4 sections animate on scroll
   - Transitions between sections are smooth
   - No jank or stutter

4. **Performance:**
   - 60fps maintained throughout
   - GPU-accelerated transforms only
   - No layout thrashing
</verification>

<success_criteria>
- Points badge with animated counter works
- Source breakdown shows all three categories
- Flow lines animate drawing
- Tuition card shows reduction
- Loop indicator appears at end
- All animations scroll-linked
- Complete 4-section experience working
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-how-it-works/07-09-SUMMARY.md`
</output>
